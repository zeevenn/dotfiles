#!/bin/bash
# Usage: ide [path]
# Default: use current directory
#
#  Single window layout:
#  ┌──────────────────────┐
#  │                      │
#  │        Code          │  <- vim (zoomed by default)
#  │                      │
#  ├──────────┬───────────┤
#  │  Term 1  │  Term 2   │  <- hidden, toggle with prefix+z
#  └──────────┴───────────┘
#
#  Tips:
#  - prefix+z: toggle terminal visibility
#  - prefix+Alt+2: even-horizontal (re-balance after adding panes)
#

DIR=${1:-$(pwd)}
SESSION=$(basename "$DIR" | tr . _)

# Check if session exists using exact match
if tmux list-sessions -F '#{session_name}' 2>/dev/null | grep -q "^${SESSION}$"; then
  SESSION_EXISTS=true
else
  SESSION_EXISTS=false
fi

# If session doesn't exist, create it
if [ "$SESSION_EXISTS" = "false" ]; then
  # Create new session with code pane
  tmux new-session -d -s "$SESSION" -c "$DIR" -n ide

  # Split: bottom terminal area (20% height)
  tmux split-window -v -l 20% -t "$SESSION":0 -c "$DIR"

  # Split bottom into 2 horizontal panes
  tmux split-window -h -t "$SESSION":0.1 -c "$DIR"

  # Select code pane and start vim
  tmux select-pane -t "$SESSION":0.0
  tmux send-keys -t "$SESSION":0.0 "vi ." C-m

  # Zoom the code pane (hide terminals)
  tmux resize-pane -Z -t "$SESSION":0.0
fi

# Attach or switch to session
if [ -n "$TMUX" ]; then
  # Already in tmux, switch to the session
  tmux switch-client -t "$SESSION"
else
  # Not in tmux, attach to the session
  tmux attach -t "$SESSION"
fi
