#!/usr/bin/env bash
#
# bootstrap installs things.

cd "$(dirname "$0")/.."
DOTFILES_ROOT=$(pwd -P)

set -e

info() {
  printf "[ \033[00;34m..\033[0m ] $1\n"
}

user() {
  printf "[ \033[0;33m??\033[0m ] $1\n"
}

success() {
  printf "[ \033[00;32mOK\033[0m ] $1\n"
}

fail() {
  printf "[\033[0;31mFAIL\033[0m] $1\n"
  echo ''
  exit
}

section() {
  echo ''
  printf "\033[1;36m==>\033[0m \033[1m$1\033[0m\n"
}

setup_gitconfig() {
  if ! [ -f .config/git/config.local ]; then
    info 'setup gitconfig'

    git_credential='cache'
    if [ "$(uname -s)" == "Darwin" ]; then
      git_credential='osxkeychain'
    fi

    user ' - What is your github author name?'
    read -e git_authorname
    user ' - What is your github author email?'
    read -e git_authoremail

    sed -e "s/AUTHORNAME/$git_authorname/g" -e "s/AUTHOREMAIL/$git_authoremail/g" -e "s/GIT_CREDENTIAL_HELPER/$git_credential/g" .config/git/config.local.example >.config/git/config.local

    success 'gitconfig'
  else
    success 'Git already set up'
  fi
}

setup_ssh_key() {
  local ssh_key="$HOME/.ssh/id_ed25519"

  if ! [ -f "$ssh_key" ]; then
    info 'setup SSH key'

    user ' - Generate SSH key? [y/n]'
    read -e ssh_input

    case "$ssh_input" in
    y | Y | yes | YES)
      user ' - Enter SSH key comment (usually your email)'
      read -e ssh_comment

      # Create .ssh directory if it doesn't exist
      mkdir -p "$HOME/.ssh"
      chmod 700 "$HOME/.ssh"

      # Generate ED25519 key
      ssh-keygen -t ed25519 -f "$ssh_key" -C "$ssh_comment" -N ""

      success "SSH key generated at $ssh_key"

      # Display public key and add to ssh-agent
      echo ''
      info 'Adding SSH key to ssh-agent'
      eval "$(ssh-agent -s)" >/dev/null 2>&1

      if [ "$(uname -s)" == "Darwin" ]; then
        ssh-add --apple-use-keychain "$ssh_key"
      else
        ssh-add "$ssh_key"
      fi

      success 'SSH key added to agent'

      # Show public key
      echo ''
      echo "  Your public SSH key:"
      echo ''
      sed 's/^/    /' "$ssh_key.pub"
      echo ''
      user ' - Add this key to GitHub, GitLab, or Bitbucket'
      user '   GitHub:  https://github.com/settings/keys'
      user '   GitLab:  https://gitlab.com/-/profile/keys'
      user '   Bitbucket: https://bitbucket.org/account/settings/ssh-keys/'
      echo ''
      ;;
    n | N | no | NO | "")
      success 'skipped SSH key generation'
      ;;
    esac
  else
    success 'SSH key already exists'
  fi
}

generate_ssh_config() {
  local proxy_host="$1"
  local proxy_port="$2"
  local ssh_config_local="$DOTFILES_ROOT/.ssh/config.local"

  cat >"$ssh_config_local" <<EOF
# Local SSH configuration (machine-specific)
# Auto-generated by script/bootstrap
# This file is NOT tracked by git
EOF

  # Add GitHub proxy if configured
  if [ -n "$proxy_host" ] && [ -n "$proxy_port" ]; then
    cat >>"$ssh_config_local" <<EOF

# GitHub with proxy
Host github.com
  ProxyCommand nc -x $proxy_host:$proxy_port ssh.github.com %p
EOF
  fi

  # Add example server
  cat >>"$ssh_config_local" <<EOF

# Example: Custom server
# Host myserver
#   HostName server.example.com
#   User username
#   Port 22
#   IdentityFile ~/.ssh/id_rsa_myserver
EOF
}

setup_proxy() {
  if ! [ -f proxy/env.local ]; then
    info 'setup proxy'

    user ' - Enable proxy? [y=default(http://127.0.0.1:7890)/n=no/custom URL]'
    read -e proxy_input

    case "$proxy_input" in
    y | Y | yes | YES)
      # Use default proxy
      proxy_url="http://127.0.0.1:7890"
      proxy_host="127.0.0.1"
      proxy_port="7890"
      ;;
    n | N | no | NO | "")
      # Skip proxy configuration
      generate_ssh_config "" ""
      success 'proxy configuration skipped'
      return
      ;;
    *)
      # Custom URL
      proxy_url="$proxy_input"
      # Extract host and port from URL
      proxy_host_port=$(echo "$proxy_url" | sed -E 's|^https?://||' | sed -E 's|/.*$||')
      proxy_host=$(echo "$proxy_host_port" | cut -d: -f1)
      proxy_port=$(echo "$proxy_host_port" | cut -d: -f2)
      ;;
    esac

    # Generate HTTP proxy config
    cat >proxy/env.local <<EOF
export DOTFILES_PROXY_URL="$proxy_url"
EOF
    success "proxy configured: $proxy_url"

    # Generate SSH proxy config
    generate_ssh_config "$proxy_host" "$proxy_port"
    success "SSH proxy configured for GitHub"
  else
    success 'proxy already configured'
  fi
}

install_zinit() {
  local ZINIT_HOME="${XDG_DATA_HOME:-${HOME}/.local/share}/zinit/zinit.git"

  if [ ! -d "$ZINIT_HOME" ]; then
    info 'installing Zinit'
    mkdir -p "$(dirname $ZINIT_HOME)"
    git clone https://github.com/zdharma-continuum/zinit.git "$ZINIT_HOME"
    success 'Zinit installed'
  else
    success 'Zinit already installed'
  fi
}

install_tpm() {
  local TPM_HOME="$DOTFILES_ROOT/.config/tmux/plugins/tpm"

  if [ ! -d "$TPM_HOME" ]; then
    info 'installing TPM (Tmux Plugin Manager)'
    mkdir -p "$(dirname $TPM_HOME)"
    git clone https://github.com/tmux-plugins/tpm "$TPM_HOME"
    success 'TPM installed'
  else
    success 'TPM already installed'
  fi
}

section "Configuring Git and SSH"
setup_gitconfig
setup_ssh_key

section "Setting up Proxy"
setup_proxy

section "Installing Plugin Managers"
install_zinit
install_tpm

section "Creating Symlinks"
"$DOTFILES_ROOT/script/link"

section "Installing Dependencies"
# If we're on a Mac, let's install and setup homebrew.
if [ "$(uname -s)" == "Darwin" ]; then
  if source bin/dot 2>&1 | while read -r data; do info "$data"; done; then
    success "dependencies installed"
  else
    fail "error installing dependencies"
  fi
fi

echo ''
printf "\033[1;32mâœ“\033[0m \033[1mBootstrap complete!\033[0m\n"
echo ''
